<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empleados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="../CSS/style.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            padding-top: 60px;
        }

        footer {
            margin-top: auto;
        }

        h1 {
            font-family: 'Arial', sans-serif;
            font-size: 28pt;
            color: #675541;
        }

        .btn-custom {
            background-color: #FEBF00;
            color: #000;
        }

        .btn-custom:hover {
            background-color: #e0aa00;
        }

        .table thead {
            background-color: #675541;
            color: white;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-custom fixed-top bg-transparent ">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="../IMG/logo.png" alt="Logo" class="logo" />
            </a>
            <div class="collapse navbar-collapse" id="menuPrincipal">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-center">
                    <li class="nav-item"><a class="nav-link" href="clientes.html">Clientes</a></li>
                    <li class="nav-item"><a class="nav-link" href="empleados.html">Empleados</a></li>
                    <li class="nav-item"><a class="nav-link" href="inventario.html">Inventario</a></li>
                    <li class="nav-item"><a class="nav-link" href="entregas.html">Entregas</a></li>
                    <li class="nav-item"><a class="nav-link" href="proveedores.html">Proveedores</a></li>
                    <li class="nav-item"><a class="nav-link" href="dashboardReportes.html">Reportes</a></li>
                    <li class="nav-item">
                    <li class="nav-item"><a class="nav-link" href="registro.html"> <i class="fas fa-user"></i> Gestionar
                            Credenciales</a></li>
                    <li class="nav-item"><a class="nav-link" href="login.html"> <i class="fas fa-sign-out-alt"></i>
                            Cerrar Sesión</a></li>
                    </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        <h1>Lista de Empleados</h1>
        <div class="text-end">
            <button class="btn btn-custom my-3" data-bs-toggle="modal" data-bs-target="#modalAgregarEmpleado">Registrar
                Empleado</button>
        </div>

        <div id="mensajeExito" class="alert alert-success d-none" role="alert">
            Se ha guardado correctamente
        </div>

        <div id="mensajeExitoActualizacion" class="alert alert-success d-none" role="alert">
            Empleado actualizado correctamente
        </div>

        <input type="text" id="buscarEmpleado" class="form-control mb-3" placeholder="Buscar empleado...">

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Fecha Ingreso</th>
                    <th>Puesto</th>
                    <th>Días de vacaciones</th>
                    <th>Curriculum</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaEmpleados"></tbody>
        </table>
    </div>

    <div class="modal fade" id="modalAgregarEmpleado" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formAgregarEmpleado" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title">Registrar Empleado</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label>Nombre Completo</label>
                            <input type="text" class="form-control" id="nombreEmpleado" required>
                        </div>
                        <div class="mb-3">
                            <label>Fecha de Ingreso</label>
                            <input type="date" class="form-control" id="fechaIngreso" required>
                        </div>
                        <div class="mb-3">
                            <label>Puesto</label>
                            <input type="text" class="form-control" id="puestoEmpleado" required>
                        </div>
                        <div class="mb-3">
                            <label>Días de Vacaciones</label>
                            <input type="number" class="form-control" id="vacacionesEmpleado" required>
                        </div>
                        <div class="mb-3">
                            <label for="estadoEmpleado" class="form-label">Estado</label>
                            <select class="form-control" id="estadoEmpleado" required>
                                <option value="">Seleccione un estado</option>
                                <option value="1">Activo</option>
                                <option value="0">Inactivo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="archivoEmpleado">Adjuntar curriculum</label>
                            <input type="file" class="form-control" id="archivoEmpleado" name="archivo"
                                accept=".pdf,.jpg,.png,.doc,.docx">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-custom" type="submit">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditarEmpleado" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formEditarEmpleado" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Empleado</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="indiceEmpleado">
                        <div class="mb-3">
                            <label>Nombre Completo</label>
                            <input type="text" class="form-control" id="editNombreEmpleado" required>
                        </div>
                        <div class="mb-3">
                            <label>Fecha de Ingreso</label>
                            <input type="date" class="form-control" id="editFechaIngreso" required>
                        </div>
                        <div class="mb-3">
                            <label>Puesto</label>
                            <input type="text" class="form-control" id="editPuestoEmpleado" required>
                        </div>
                        <div class="mb-3">
                            <label>Días de Vacaciones</label>
                            <input type="number" class="form-control" id="editVacacionesEmpleado" required>
                        </div>
                        <div class="mb-3">
                            <label for="archivoEmpleado">Adjuntar curriculum</label>
                            <input type="file" id="editArchivoEmpleado" name="archivo" class="form-control"
                                accept=".pdf,.doc,.docx,.jpg,.png">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-custom" type="submit">Actualizar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Cambiar Estado -->
    <div class="modal fade" id="modalCambiarEstado" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cambiar Estado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="indiceEstadoEmpleado" />
                    <label for="nuevoEstado" class="form-label">Seleccione nuevo estado</label>
                    <select id="nuevoEstado" class="form-control">
                        <option value="1">Activo</option>
                        <option value="0">Inactivo</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-sm btn-warning" onclick="guardarNuevoEstado()">Guardar Estado</button>
                </div>
            </div>
        </div>
    </div>

    <!--
    <div class="modal fade" id="modalAsignarRol" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Asignar Rol</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="indiceRolEmpleado">
                    <label>Seleccione el rol</label>
                    <select id="rolEmpleado" class="form-control">
                        <option value="Empleado">Empleado</option>
                        <option value="Administrador">Administrador</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="guardarRol()">Guardar Rol</button>
                </div>
            </div>
        </div>
    </div>
-->

    <!-- Footer -->
    <footer class="footer-custom mt-auto py-4">
        <div class="container text-center">
            <p class="mb-1 fw-bold">Abrasivos Industriales S.A.</p>
            <p class="mb-0 small">© 2025 Todos los derechos reservados</p>
        </div>
    </footer>

    <script>
        const buscar = document.getElementById("buscarEmpleado");
        const tabla = document.getElementById("tablaEmpleados");
        const modalEditarEmpleado = document.getElementById('modalEditarEmpleado');

        async function cargarEmpleados() {
            const res = await fetch("../backend/Empleados.php?accion=listar");
            const data = await res.json();

            tabla.innerHTML = "";
            data.forEach(emp => {
                const estadoTexto = emp.estado == "1" ? "Activo" : "Inactivo";
                const archivoLink = emp.archivo
                    ? `<a href="../${emp.archivo}" target="_blank">Ver archivo</a>`
                    : 'Sin archivo';
                tabla.innerHTML += `
        <tr>
            <td>${emp.nombre_completo}</td>
            <td>${formatoFecha(emp.fecha_ingreso)}</td>
            <td>${emp.puesto}</td>
            <td>${emp.dias_vacaciones}</td>
            <td>${archivoLink}</td>
            <td>${estadoTexto}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="abrirEditar(${emp.id_empleado})">Editar</button>
                <button class="btn btn-sm btn-warning" onclick="abrirModalCambiarEstado(${emp.id_empleado}, '${estadoTexto}')">Estado</button>
            </td>
        </tr>`;
            });
        }

        window.onload = cargarEmpleados;

        document.getElementById("formAgregarEmpleado").addEventListener("submit", async e => {
            e.preventDefault();

            const formData = new FormData();
            formData.append("nombre", nombreEmpleado.value);
            formData.append("fecha", fechaIngreso.value);
            formData.append("vacaciones", vacacionesEmpleado.value);
            formData.append("puesto", puestoEmpleado.value);
            formData.append("estado", estadoEmpleado.value);

            // archivo
            const archivo = document.getElementById("archivoEmpleado").files[0];
            if (archivo) {
                formData.append("archivo", archivo);
            }

            const res = await fetch("../backend/Empleados.php?accion=agregar", {
                method: "POST",
                body: formData
            });

            const result = await res.json();

            if (result.success) {
                alert("Empleado agregado con éxito");
                e.target.reset();
                bootstrap.Modal.getInstance(modalAgregarEmpleado).hide();
                cargarEmpleados();
            } else {
                alert("Error al guardar empleado");
            }
        });


        async function abrirEditar(id) {
            const res = await fetch("../backend/Empleados.php?accion=listar");
            const empleados = await res.json();
            const emp = empleados.find(e => e.id_empleado == id);
            if (!emp) return;

            indiceEmpleado.value = emp.id_empleado;
            editNombreEmpleado.value = emp.nombre_completo;
            editFechaIngreso.value = emp.fecha_ingreso;
            editPuestoEmpleado.value = emp.puesto;
            editVacacionesEmpleado.value = emp.dias_vacaciones;
            document.getElementById("editArchivoEmpleado").value = "";
            new bootstrap.Modal(modalEditarEmpleado).show();
        }

        document.getElementById("formEditarEmpleado").addEventListener("submit", async e => {
            e.preventDefault();

            const formData = new FormData();
            formData.append("id", indiceEmpleado.value);
            formData.append("nombre", editNombreEmpleado.value);
            formData.append("fecha", editFechaIngreso.value);
            formData.append("vacaciones", editVacacionesEmpleado.value);
            formData.append("puesto", editPuestoEmpleado.value);

            const archivo = document.getElementById("editArchivoEmpleado").files[0];
            if (archivo) {
                formData.append("archivo", archivo);
            }

            const res = await fetch("../backend/Empleados.php?accion=editar", {
                method: "POST",
                body: formData
            });
            const result = await res.json();

            if (result.success) {
                alert("Empleado editado con éxito");
                bootstrap.Modal.getInstance(modalEditarEmpleado).hide();
                cargarEmpleados();
            } else {
                alert("Error al editar");
            }
        });


        function abrirModalCambiarEstado(id, estadoActual) {
            document.getElementById('indiceEstadoEmpleado').value = id;
            document.getElementById('nuevoEstado').value = estadoActual === 'Activo' ? 1 : 0;
            const modal = new bootstrap.Modal(document.getElementById('modalCambiarEstado'));
            modal.show();
        }

        async function guardarNuevoEstado() {
            const id = document.getElementById("indiceEstadoEmpleado").value;
            const estado = document.getElementById("nuevoEstado").value;

            const res = await fetch("../backend/Empleados.php?accion=cambiarEstado", {
                method: "POST",
                body: JSON.stringify({ id, estado })
            });

            const data = await res.json();
            if (data.success) {
                alert("Estado actualizado");
                cargarEmpleados();
                bootstrap.Modal.getInstance(document.getElementById('modalCambiarEstado')).hide();
            } else {
                alert("Error al actualizar estado");
            }
        }

        /*
           const asignarRol = i => {
               indiceRolEmpleado.value = i;
               rolEmpleado.value = empleados[i].rol;
               new bootstrap.Modal(modalAsignarRol).show();
           };
   
           const guardarRol = () => {
               empleados[+indiceRolEmpleado.value].rol = rolEmpleado.value;
               bootstrap.Modal.getInstance(modalAsignarRol).hide();
               renderTablaEmpleados();
               mensaje2.classList.remove("d-none");
               setTimeout(() => mensaje2.classList.add("d-none"), 3000);
           };
   
           */
        buscar.addEventListener("input", renderTablaEmpleados);


        function formatoFecha(fecha) {
            if (!fecha) return "";
            const [anio, mes, dia] = fecha.split("-");
            return `${dia}/${mes}/${anio}`;
        }

    </script>
</body>

</html>