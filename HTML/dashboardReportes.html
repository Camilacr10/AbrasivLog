<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inicio - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="../CSS/style.css">
  <style>
    .encabezado-pdf { text-align: center; margin-bottom: 20px; }
    .encabezado-pdf img { max-width: 100px; margin-bottom: 10px; }
    .encabezado-pdf h4 { margin: 0; font-weight: bold; }
    .encabezado-pdf small { font-style: italic; color: #555; }
    h1 { font-family: 'Arial', sans-serif; font-size: 28pt; color: #675541; }
   .nav-link.active {color: #675541 !important;font-weight: 600;}
   .nav-link:hover, .nav-link:focus {color: #FEBF00 !important;}
  </style>
</head>
<body>
  <!-- Menú -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="../IMG/logo.png" alt="Logo" class="logo" />
      </a>
      <div class="collapse navbar-collapse" id="menuPrincipal">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-center">
          <li class="nav-item"><a class="nav-link" href="clientes.html">Clientes</a></li>
          <li class="nav-item"><a class="nav-link" href="empleados.html">Empleados</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="inventarioDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Inventario</a>
            <ul class="dropdown-menu" aria-labelledby="inventarioDropdown">
              <li><a class="dropdown-item" href="inventario.html">Inventario de Productos</a></li>
              <li><a class="dropdown-item" href="inventarioCategorias.html">Inventario de Categorías</a></li>
            </ul>
          <li class="nav-item"><a class="nav-link" href="entregas.html">Entregas</a></li>
          <li class="nav-item"><a class="nav-link" href="proveedores.html">Proveedores</a></li>
          <li class="nav-item"><a class="nav-link active" href="dashboardReportes.html">Reportes</a></li>
 
 <li class="nav-item" id="linkCredenciales">
  <a class="nav-link" href="registro.html">
    <i class="fas fa-user me-1 opacity-75"></i> Gestionar Credenciales
  </a>
</li>

  
          <li class="nav-item dropdown ms-3">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="usuarioDropdown"
               role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fa-regular fa-circle-user me-2"></i>
              <span id="usuarioActual">Cargando...</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="usuarioDropdown">
              <li><a class="dropdown-item disabled small" id="usuarioRol">Rol: -</a></li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <button class="dropdown-item text-danger" onclick="salir()">
                  <i class="fas fa-sign-out-alt me-2"></i> Cerrar sesión
                </button>
              </li>
            </ul>
          </li>

        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-3 mb-5">
    <div class="d-flex align-items-center gap-3">
      <h1 class="mb-0">Dashboard y Reporte</h1>
    </div>
    <br>

    <!-- Métricas -->
    <div class="row g-4 text-white">
      <div class="col-md-4">
        <div class="card bg-primary shadow-sm text-center p-3">
          <i class="fas fa-users fa-2x mb-2"></i>
          <h6>Clientes</h6>
          <h4 id="totalClientes">0</h4>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card bg-warning text-dark shadow-sm text-center p-3">
          <i class="fas fa-box fa-2x mb-2"></i>
          <h6>Pedidos</h6>
          <h4 id="totalPedidos">0</h4>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card bg-info text-dark shadow-sm text-center p-3">
          <i class="fas fa-industry fa-2x mb-2"></i>
          <h6>Proveedores</h6>
          <h4 id="totalProveedores">0</h4>
        </div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-4 mt-4">
      <div class="col-md-6">
        <div class="card shadow-sm p-3">
          <h5 class="mb-3">Top 5 Productos Más Vendidos</h5>
          <div class="chart-container">
            <canvas id="barChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm p-3">
          <h5 class="mb-3">Clientes Frecuentes</h5>
          <div class="chart-container" style="height: 300px;">
            <canvas id="donutChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Tablas -->
    <div class="row g-4 mt-4">
      <div class="col-md-6" id="reporteEntregas">
        <div class="card shadow-sm p-3">
          <h5 class="mb-3">Entregas Pendientes</h5>
          <table class="table align-middle text-center">
            <thead class="table-warning">
              <tr>
                <th><i class="fas fa-user"></i> Cliente</th>
                <th><i class="fas fa-box"></i> Producto</th>
                <th><i class="fas fa-calendar-alt"></i> Fecha</th>
                <th><i class="fas fa-clock"></i> Estado</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="text-muted">Cargando...</td></tr>
            </tbody>
          </table>
          <button class="btn btn-outline-secondary me-2"
            onclick="descargarReporteLimpio({ id:'reporteEntregas', filename:'entregas_pendientes.pdf', title:'Reporte de Entregas Pendientes', orientation:'landscape' })">
            <i class="fas fa-download me-1"></i> Entregas Pendientes
          </button>
        </div>
      </div>

      <div class="col-md-6" id="reporteProveedores">
        <div class="card shadow-sm p-3">
          <h5 class="mb-3">Top Proveedores</h5>
          <table class="table table-bordered table-sm align-middle">
            <thead class="table-success text-center">
              <tr>
                <th>Proveedor</th>
                <th>Calificación</th>
                <th>Teléfono</th>
              </tr>
            </thead>
            <tbody class="text-center">
              <tr><td colspan="3" class="text-muted">Cargando...</td></tr>
            </tbody>
          </table>
          <button class="btn btn-outline-secondary"
            onclick="descargarReporteLimpio({ id:'reporteProveedores', filename:'top_proveedores.pdf', title:'Reporte de Top Proveedores', orientation:'landscape' })">
            <i class="fas fa-download me-1"></i> Top Proveedores
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer-custom mt-auto py-4">
    <div class="container text-center">
      <p class="mb-1 fw-bold">Abrasivos Industriales S.A.</p>
      <p class="mb-0 small">© 2025 Todos los derechos reservados</p>
    </div>
  </footer>

  <!-- Librería jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const { jsPDF } = window.jspdf;

    // === FUNCIONES AUXILIARES ===
    function formatearFecha(fecha) {
      const d = new Date(fecha);
      if (isNaN(d)) return fecha;
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    // === DESCARGA PDF PARA ENTREGAS ===
    window.descargarPorId = async function (id, nombreArchivo, tituloReporte) {
      const doc = new jsPDF({ orientation: 'landscape' });
      let y = 15;

      // Logo y título
      const logo = new Image();
      logo.src = '../IMG/logo.png';
      doc.addImage(logo, 'PNG', 14, 10, 15, 15);
      doc.setFontSize(14);
      doc.text('Abrasivos Industriales S.A.', 32, 18);
      doc.setFontSize(11);
      doc.text(tituloReporte, 32, 26);
      y = 40;

      // Fecha actual
      doc.setFontSize(9);
      doc.text(`Generado: ${new Date().toLocaleString('es-CR')}`, 250, 18, null, null, 'right');

      // Obtener tabla y datos
      const card = document.getElementById(id);
      const tabla = card?.querySelector('table');
      if (!tabla) {
        doc.text('No se encontraron datos para mostrar.', 14, y);
        doc.save(nombreArchivo);
        return;
      }

      const filas = [...tabla.querySelectorAll('tbody tr')];
      if (filas.length === 0) {
        doc.text('No hay registros para exportar.', 14, y);
        doc.save(nombreArchivo);
        return;
      }

      // Cabeceras
      const cabeceras = [...tabla.querySelectorAll('thead th')].map(th => th.innerText.trim());
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      let x = 14;
      cabeceras.forEach((txt, i) => {
        doc.text(txt, x, y);
        x += 65;
      });
      y += 8;
      doc.setFont('helvetica', 'normal');

      // Filas
      filas.forEach((fila) => {
        const celdas = [...fila.querySelectorAll('td')].map(td => td.innerText.trim());
        x = 14;
        celdas.forEach((celda) => {
          doc.text(celda || '-', x, y);
          x += 65;
        });
        y += 8;
        if (y > 190) { // salto de página
          doc.addPage();
          y = 20;
        }
      });

      // Pie de página
      const total = doc.internal.getNumberOfPages();
      for (let i = 1; i <= total; i++) {
        doc.setPage(i);
        doc.setFontSize(9);
        doc.text(`Página ${i} de ${total}`, 280, 200, null, null, 'right');
        doc.text('Abrasivos Industriales S.A.', 14, 200);
      }

      // Guardar PDF
      doc.save(nombreArchivo);
    };
  });
  </script>

  <!-- Lógica del dashboard -->
  <script src="../JS/dashboardReportes.js"></script>
</body>
</html>
